#include "addproject.h"
#include "ui_addproject.h"

#include <QToolBar>
#include <QLayout>
#include <QMenuBar>

#include <QMessageBox>

AddProject::AddProject(QWidget *parent) :
    QDialog(parent),
    ui(new Ui::AddProject)
{
    ui->setupUi(this);
    newProject = NULL;

    this->setWindowTitle("New project");

    calibNoMarkers = calibMarkers = false;
}

AddProject::~AddProject()
{
    delete ui;
}

void AddProject::on_buttonBox_accepted()
{
    newProject = new Room(NULL, vec3(ui->width->text().toInt(), ui->length->text().toInt(), ui->height->text().toInt() ),
                        ui->epsilon->text().toFloat(), ui->name->text().toStdString());

    for(size_t i = 0; i < newCameras.size(); i++)
    {
        newProject->AddCamera(newCameras[i]);
    }
}

void AddProject::EditProject(Room *Project)
{
    std::vector<CaptureCamera*> cameras = Project->getcameras();

    for(size_t i = 0; i < cameras.size(); i++)
    {
        cameras[i]->TurnOff();
        cameras[i]->Hide();
        addCamToTable(cameras[i]);
    }

    vec3 dims = Project->getDimensions();

    ui->width->setText(QString::number(dims.x));
    ui->length->setText(QString::number(dims.y));
    ui->height->setText(QString::number(dims.z));

    ui->epsilon->setText(QString::number(Project->getEpsilon()));
    ui->name->setText(QString::fromStdString(Project->getName()));

    this->setWindowTitle(QString::fromStdString(Project->getName()));
}

void AddProject::addCamToTable(CaptureCamera *temp)
{
    int row = ui->CameraTable->rowCount();
    ui->CameraTable->insertRow(row);

    QTableWidgetItem *x = new QTableWidgetItem(QString::number(temp->getID()));
    ui->CameraTable->setItem(row, 0, x);
    x = new QTableWidgetItem(QString::number(temp->getPosition().x));
    ui->CameraTable->setItem(row, 1, x);
    x = new QTableWidgetItem(QString::number(temp->getPosition().y));
    ui->CameraTable->setItem(row, 2, x);
    x = new QTableWidgetItem(QString::number(temp->getPosition().z));
    ui->CameraTable->setItem(row, 3, x);
    x = new QTableWidgetItem(QString::number(temp->getAngle()));
    ui->CameraTable->setItem(row, 4, x);
    x = new QTableWidgetItem(QString::fromStdString(temp->getName()));
    ui->CameraTable->setItem(row, 5, x);

    x = new QTableWidgetItem(Qt::CheckStateRole);
    x->setCheckState(Qt::Unchecked);
    ui->CameraTable->setItem(row,6,x);

    x = new QTableWidgetItem(Qt::CheckStateRole);
    x->setCheckState(Qt::Unchecked);
    ui->CameraTable->setItem(row,7,x);
}

void AddProject::on_CameraTable_cellChanged(int row, int column)
{
    QTableWidgetItem *item = ui->CameraTable->item(row, column);

    switch (column)
    {
    case 4:
            newCameras[row]->setAngle(item->text().toFloat());
        break;
    case 6:
        if(item->checkState() == Qt::Checked)
            newCameras[row]->TurnOn();
        else
            newCameras[row]->TurnOff();
        break;
    case 7:
        if(item->checkState() == Qt::Checked)
            newCameras[row]->Show();
        else
            newCameras[row]->Hide();
        break;
    default:
        break;
    }
}

void AddProject::on_deleteCamera_pressed()
{
    QItemSelectionModel *selection = ui->CameraTable->selectionModel();

    if(selection->hasSelection())
    {
        QModelIndexList indexes = selection->selectedRows();

        size_t index;
        for(int i = indexes.size()-1; i >= 0; i--)
        {
            index = indexes.at(i).row();
            ui->CameraTable->removeRow(index);

            newCameras[index]->Hide();
            newCameras[index]->TurnOff();
            newCameras.erase(newCameras.begin()+index);
        }
    }
}

void AddProject::on_AddCamera_clicked()
{
    AddCamera addcamera(this, vec3(ui->width->text().toInt(), ui->length->text().toInt(), ui->height->text().toInt()));
    addcamera.setModal(true);
    bool ok = addcamera.exec();

    if(ok) // indexes are X (0) Y(1) Z(2) USB index(3) Angle(4)
    {
        CaptureCamera *temp = addcamera.getCam();
        //temp->setDimensions(NewProject->getDimensions());
        newCameras.push_back(temp);

        addCamToTable(temp);
    }
}

void AddProject::on_name_textEdited(const QString &arg1)
{
    this->setWindowTitle(arg1);
}


void AddProject::on_CalibNoMarkers_clicked()
{
    for(size_t i = 0; i < newCameras.size(); i++)
    {
        newCameras[i]->CalibNoMarkers();
    }

    calibNoMarkers = true;
}

void AddProject::on_CalibWithMarkers_clicked()
{
    ui->TextWithMarkers->setText(QString::fromStdString(""));
    int numOfMarkers = ui->numLEDs->text().toInt();

    for(size_t i = 0; i < newCameras.size(); i++)
    {
        ui->TextWithMarkers->append(QString::fromStdString(newCameras[i]->getName() + ": "));
        ui->TextWithMarkers->append(QString::number(newCameras[i]->CalibWithMarkers(numOfMarkers)));
    }

    calibMarkers = true;
}

void AddProject::on_editCamera_clicked()
{

}
